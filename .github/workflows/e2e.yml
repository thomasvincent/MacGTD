name: E2E Tests

on:
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - alfred
          - automator

permissions:
  contents: read

jobs:
  e2e-tests:
    name: E2E Tests (${{ github.event.inputs.test_suite }})
    runs-on: [self-hosted, macOS, e2e]
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4

      - name: System info
        run: |
          echo "macOS: $(sw_vers -productVersion)"
          echo "Arch: $(uname -m)"
          echo "Alfred: $(ls /Applications/Alfred*.app 2>/dev/null || echo 'not found')"
          echo "Runner: $(hostname)"

      - name: Run repo validation
        run: |
          chmod +x tests/validate_repo.sh
          ./tests/validate_repo.sh

      - name: Run AppleScript syntax tests
        run: |
          chmod +x tests/test_applescript_syntax.sh
          ./tests/test_applescript_syntax.sh

      - name: Run Automator loading tests
        run: |
          chmod +x tests/test_automator_loading.sh
          ./tests/test_automator_loading.sh

      - name: Run NLP parser tests
        run: |
          chmod +x tests/test_natural_language_parser.sh
          ./tests/test_natural_language_parser.sh

      - name: Run Reminders integration tests
        run: |
          chmod +x tests/test_reminders_integration.sh
          ./tests/test_reminders_integration.sh

      - name: Run Alfred E2E tests
        if: github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'alfred'
        run: |
          chmod +x tests/e2e/test_alfred_workflow.sh
          ./tests/e2e/test_alfred_workflow.sh

      - name: Run Automator install tests
        if: github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'automator'
        run: |
          chmod +x tests/e2e/test_automator_install.sh
          ./tests/e2e/test_automator_install.sh

      - name: Package Alfred workflow
        run: |
          chmod +x scripts/package-alfred.sh
          ./scripts/package-alfred.sh

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: e2e-results
          path: |
            dist/MacGTD.alfredworkflow
          retention-days: 7
